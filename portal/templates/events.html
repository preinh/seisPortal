<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">

<xi:include href="master.html"/>

<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" py:if="False"/>
<title>Event List</title>

<!--<script type="text/javascript" src="${url('/resources/tw2.jquery/static/jquery/1.8.0/jquery.js')}"></script>-->

<!--<script type="text/javascript"-->
        <!--src="${url('/resources/tw2.jqplugins.ui/static/jquery/ui/1.8.23/js/jquery-ui.js')}"></script>-->
<!--<link rel="stylesheet" type="text/css"-->
      <!--href="${url('/resources/tw2.jqplugins.ui/static/jquery/ui/1.8.23/css/smoothness/jquery-ui.css')}" media="all"/>-->

<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=AIzaSyAnoSK2eAZ-aaXYnvMOaTesb9WyYGra1ik&amp;sensor=false"
        type="text/javascript"></script>

<script type="text/javascript">
//<![CDATA[

${json}

${json_l}


/**
 * The map object, null until script loads in.
 * @type {GMap2}
 */
var map = null;
var map2 = null;

/**
 * The bounds of the markers once loaded in.
 * @type {GLatLngBounds}
 */
var bounds = null;
var bounds2 = null;

/**
 * The marker with currently opened info window.
 * @type {GMarker}
 */
var currentMarker = null;
var currentMarker2 = null;

/**
 * The dom element that the map is loaded into
 * @type {Element}
 */
var mapDivEvents = null;
var mapDivBsb = null;

/**
 * The dom element that everything is a child of.
 * @type {Element}
 */
var containerDiv = null;
var containerDiv2 = null;

/**
 * Position of mouse click (clientX) on map div when in static mode.
 * @type {Number}
 */
var clickedX = 0;
var clickedX2 = 0;

/**
 * Position of mouse click (clientY) on map div when in static mode.
 * @type {Number}
 */
var clickedY = 0;
var clickedY2 = 0;

/**
 * Called after script is asynchronously loaded in.
 * Creates the GMap2, GMarker objects and performs actions according to
 * what the user did to trigger the map load (search, zoom, click etc).
 */
function loadMap() {
    if (GBrowserIsCompatible()) {
        mapDivEvents.style.background = '#fff';
        mapDivBsb.style.background = '#fff';

        mapDivEvents.style.cursor = '';
        mapDivBsb.style.cursor = '';

        map = new GMap2(mapDivEvents, {logoPassive:true});
        map2 = new GMap2(mapDivBsb, {logoPassive:true});

        map.setMapType(G_PHYSICAL_MAP);
        map2.setMapType(G_PHYSICAL_MAP);

//        map.addControl(new GSmallMapControl());
//        map.addControl(new GScaleControl());
//        map.addControl(new GMapTypeControl());
//        map.addControl(new GOverviewMapControl());

//        map2.addControl(new GSmallMapControl());
//        map2.addControl(new GScaleControl());
//        map2.addControl(new GMapTypeControl());
        /*	    map2.addControl(new GOverviewMapControl( ));
         */

        bounds = new GLatLngBounds();
        for (var i = 0; i < businesses.length; i++) {
            bounds.extend(new GLatLng(businesses[i].lat, businesses[i].lng));
        }

        bounds2 = new GLatLngBounds();
        for (var i = 0; i < last.length; i++) {
            bounds2.extend(new GLatLng(last[i].lat, last[i].lng));
        }

        var latSpan = bounds.toSpan().lat();
        var latSpan2 = bounds2.toSpan().lat();
        map.setCenter(bounds.getCenter(), map.getBoundsZoomLevel(bounds));
        map2.setCenter(bounds2.getCenter(), map2.getBoundsZoomLevel(bounds2));

        // The static map server gives markers more space when calculating
        // bounds and zoom level, so sometimes the API will give a higher
        // zoom level than was used by the static map server.
        // The .98 value is just a guess right now, may need tweaking.
        var newBounds = map.getBounds();
        var newLatSpan = newBounds.toSpan().lat();
        if (latSpan / newLatSpan > .90) {
            map.zoomOut();
        }

        var newBounds2 = map2.getBounds();
        var newLatSpan2 = newBounds2.toSpan().lat();
        if (latSpan2 / newLatSpan2 > .90) {
            map2.zoomOut();
        }


        for (var i = 0; i < businesses.length; i++) {
            var marker = createMarker(i);
            map.addOverlay(marker);
        }

        for (var i = 0; i < last.length; i++) {
            var _marker2 = createMarkerLast(i);
            map2.addOverlay(_marker2);
//            var _marker = createMarkerLast(i);
//            map.addOverlay(_marker);
        }

        map.setUIToDefault();
        map2.setUIToDefault();

        map.zoomToMaxExtent();
        map2.zoomToMaxExtent();

        map.setCenter(bounds.getCenter(), map.getBoundsZoomLevel(bounds));
        map2.setCenter(bounds2.getCenter(), map2.getBoundsZoomLevel(bounds2));
//        zoomToAll();


//        map.zoomIn();
//        map.zoomIn();
//        map.zoomIn();
//        map2.zoomOut();
//        map2.zoomOut();
//        map2.zoomOut();
//        map2.zoomOut();
//        map2.zoomOut();
    }
}

/**
 * Zooms to the viewport that fits all the markers.
 */
function zoomToAll() {
    map.setCenter(bounds.getCenter(), map.getBoundsZoomLevel(bounds));
    map2.setCenter(bounds2.getCenter(), map2.getBoundsZoomLevel(bounds2));
}

/**
 * Creates a marker for the given business.
 * @param {Number} ind
 * @return {GMarker}
 */
function createMarker(ind) {

    var baseIcon = new GIcon();
    baseIcon.shadow = null;
    baseIcon.iconSize = new GSize(12, 12);
    baseIcon.shadowSize = new GSize(0, 0);
    baseIcon.iconAnchor = new GPoint(6, 6);
    baseIcon.infoWindowAnchor = new GPoint(9, 2);
    baseIcon.infoShadowAnchor = new GPoint(18, 25);

    var coldIcon = new GIcon(baseIcon);
    coldIcon.image = "${evt_png}";

    var business = businesses[ind];
    var marker = new GMarker(new GLatLng(business.lat, business.lng), {icon:coldIcon, title:business.desc });
    return marker;
}

function createMarkerLast(ind) {

    var baseIcon = new GIcon();
    baseIcon.shadow = null;
    baseIcon.iconSize = new GSize(15, 15);
    baseIcon.shadowSize = new GSize(0, 0);
    baseIcon.iconAnchor = new GPoint(6, 6);
    baseIcon.infoWindowAnchor = new GPoint(9, 2);
    baseIcon.infoShadowAnchor = new GPoint(18, 25);

    var coldIcon = new GIcon(baseIcon);
//    coldIcon.image = "${last_evt_png}";
    coldIcon.image = "${evt_png}";
    var _last = last[ind];
    var marker = new GMarker(new GLatLng(_last.lat, _last.lng), {icon:coldIcon, title:_last.desc });
    return marker;
}

/**
 * Convenience function for creating an element and assigning an id to it.
 * @param {String} elementType
 * @param {String} id
 * @return {Element}
 */
function _cel(elementType, id) {
    var element = document.createElement(elementType);
    element.id = id;
    return element;
}

/**
 * Sets up the gadget by setting CSS and click events.
 */
function loadMapGadget() {
    mapDivEvents = document.getElementById('mapEvents');
    mapDivBsb = document.getElementById('mapBoletim');

    mapDivEvents.style.cursor = 'pointer';
    mapDivBsb.style.cursor = 'pointer';

    urlString = ['http://maps.google.com/staticmap?markers='];
    markerString = [];
    for (var i = 0; i < businesses.length; i++) {
        markerString.push(businesses[i].lat + ',' + businesses[i].lng + ',red');
    }
    urlString.push(markerString.join('|'));
    urlString.push('&amp;size=300x300');
    urlString.push('&amp;key=AIzaSyAnoSK2eAZ-aaXYnvMOaTesb9WyYGra1ik');
    mapDivEvents.style.background = 'url(\'' + urlString.join('') + '\')';

    loadMap();

}

//]]>
</script>

</head>

<body onload="loadMapGadget();" onunload="GUnload()">

<div id="getting_started">

    <h1>Lista de Eventos:</h1>

    <script>
        $(function () {
            $("#tabs").tabs();
        });
    </script>

    <div id="tabs">
        <ul>
            <li><a href="#bsb">Boletim Sísmico Brasileiro</a></li>
            <li><a href="#wec">Catálogo Mundial</a></li>
        </ul>
        <div id="bsb">
            <table width="100%">
                <tr>
                    <td height="250px" >
                        <div id="mapBoletim" style="width:100%; height:250px; overflow:hidden;"></div>
                    </td>
                </tr>
            </table>

            <table py:with="cls=cycle(('#ffffff', '#ccebef'))" width="100%" style="text-align: center;">

                ${bsbFilterForm.display(value=bsb_data)}

                <tr class='table_header'>
                    <td>Hora</td>
                    <td>Latitude</td>
                    <td>Longitude</td>
                    <td>Profundidade</td>
                    <td>Magnitude (#estacoes)</td>
                    <td>Onde</td>
                    <td>Avaliação</td>
                    <td>Author</td>
                </tr>

                <py:for each="evt in bsb">
                    <tr style="background-color: ${cls.next()};">
                        <td style="text-align: center;"><a href="${url('/')}events/${evt.id}">${evt.time}</a></td>
                        <td style="text-align: center;">${evt.lat}</td>
                        <td style="text-align: center;">${evt.lon}</td>
                        <td style="text-align: center;">${evt.dep}</td>
                        <td style="text-align: center;">${evt.mag}</td>
                        <td style="text-align: center;">${evt.desc}</td>
                        <py:choose>
                            <py:when test="evt.status == 'A' "><td style="text-align: center; color: red;">${evt.status}</td></py:when>
                            <py:when test="evt.status == 'M' "><td style=" color:#006400; text-align: center;"><b>${evt.status}</b></td></py:when>
                            <py:otherwise><td  style="text-align: center;">${evt.status}</td></py:otherwise>
                        </py:choose>
                        <td style="text-align: center;">${evt.author.split('@')[0]}</td>
                    </tr>
                </py:for>
            </table>

        </div>
        <div id="wec">


            <table width="100%">
                <tr>
                    <td height="250px" >
                        <div id="mapEvents" style="width:100%; height: 280px; overflow:hidden;"></div>
                    </td>
                </tr>
            </table>

            <table py:with="cls=cycle(('#ffffff', '#ccebef'))" width="100%" style="text-align: center;">

                ${filterForm.display(value=data)}

                <tr class='table_header'>
                    <td>Hora</td>
                    <td>Latitude</td>
                    <td>Longitude</td>
                    <td>Profundidade</td>
                    <td>Magnitude (#estacoes)</td>
                    <td>Onde</td>
                    <td>Avaliação</td>
                    <td>Author</td>
                </tr>

                <py:for each="evt in events">
                    <tr style="background-color: ${cls.next()};">
                        <td style="text-align: center;"><a href="${url('/')}events/${evt.id}">${evt.time}</a></td>
                        <td style="text-align: center;">${evt.lat}</td>
                        <td style="text-align: center;">${evt.lon}</td>
                        <td style="text-align: center;">${evt.dep}</td>
                        <td style="text-align: center;">${evt.mag}</td>
                        <td style="text-align: center;">${evt.desc}</td>
                        <py:choose>
                            <py:when test="evt.status == 'A' "><td style="text-align: center; color: red;">${evt.status}</td></py:when>
                            <py:when test="evt.status == 'M' "><td style=" color:#006400; text-align: center;"><b>${evt.status}</b></td></py:when>
                            <py:otherwise><td  style="text-align: center;">${evt.status}</td></py:otherwise>
                        </py:choose>
                        <td style="text-align: center;">${evt.author.split('@')[0]}</td>
                    </tr>
                </py:for>
            </table>

        </div>


 </div>
    </div>


    <!--
    <div class="clearingdiv" />
    <div class="notice">E nois!!!
    </div>
    -->

</body>
</html>
